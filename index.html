<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Отчёты проекта — Просмотр IFC</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#222222; --accent:#F7921E; --gray:#d9d9d9;
    }
    *{box-sizing:border-box}
    body{margin:0; font:14px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; color:var(--fg); background:var(--bg);}
    header{background:#f5f5f5; border-bottom:1px solid #dcdcdc; padding:12px 16px; display:flex; align-items:center; gap:12px;}
    header h1{font-size:16px; margin:0;}
    main{max-width:960px; margin:24px auto; padding:0 16px;}
    .card{border:1px solid #dcdcdc; border-radius:12px; padding:16px; margin:12px 0;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .row input[type="text"]{flex:1 1 420px; padding:10px 12px; border:1px solid #dcdcdc; border-radius:8px;}
    .btn{appearance:none; border:none; border-radius:14px; padding:10px 14px; background:var(--accent); color:#fff; cursor:pointer; font-weight:600}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .link{color:var(--accent); text-decoration:none; border-bottom:1px dashed var(--accent)}
    .muted{color:#666}
    .grid{display:grid; grid-template-columns:auto 1fr auto; gap:8px 12px; align-items:center}
    .grid h3{grid-column:1/-1; margin:8px 0}
    .hint{font-size:12px; color:#666}
    .file{display:inline-block; padding:6px 10px; border:1px solid #dcdcdc; border-radius:8px; white-space:nowrap}
    .hr{height:1px; background:#eee; margin:12px 0}
  </style>
</head>
<body>
  <header>
    <h1>Отчёты по проекту</h1>
  </header>
  <main>
    <section class="card">
      <div class="grid">
        <h3>Открыть IFC-модель</h3>
        <div class="muted" style="grid-column:1/-1">Два способа: выберите локальный файл или укажите путь к файлу в каталоге отчётов.</div>

        <label>Локальный файл .ifc</label>
        <div class="row">
          <input id="ifc-file" type="file" accept=".ifc" />
          <button class="btn" id="open-local" disabled>Открыть</button>
        </div>

        <div class="hr" style="grid-column:1/-1"></div>

        <label>Путь в проектной папке</label>
        <div class="row">
          <input id="ifc-path" type="text" placeholder="Например: projects/0005/models/model.ifc" />
          <button class="btn" id="open-url">Открыть</button>
        </div>
        <div class="hint" style="grid-column:1/-1">
          Пример: <span class="file">projects/0005/ifc/arch.ifc</span>. Файл должен быть доступен по тому же домену (CORS).
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Пример ссылки из карточки проекта</h3>
      <p class="muted">Если у вас уже есть известный путь к IFC, можно добавить кнопку «Открыть модель» прямо в карточку проекта:</p>
      <p>
        <a class="link" href="./viewer.html?ifc=projects/0005/ifc/example.ifc">Открыть модель проекта 0005</a>
      </p>
    </section>
  </main>

  <script>
    const $file = document.getElementById('ifc-file');
    const $openLocal = document.getElementById('open-local');
    const $path = document.getElementById('ifc-path');
    const $openUrl = document.getElementById('open-url');

    $file.addEventListener('change', () => {
      $openLocal.disabled = !$file.files.length;
    });

    // Открыть локальный файл: передаём через sessionStorage (без сервера)
    $openLocal.addEventListener('click', async () => {
      const f = $file.files && $file.files[0];
      if (!f) return;
      const key = 'ifc-local-' + Date.now();
      // сохраняем blob в sessionStorage (как object URL)
      const url = URL.createObjectURL(f);
      sessionStorage.setItem(key, JSON.stringify({ name: f.name, url }));
      // передаём ключ через query
      location.href = 'viewer.html?local=' + encodeURIComponent(key);
    });

    // Открыть по относительному пути (из папки проекта)
    $openUrl.addEventListener('click', () => {
      const v = ($path.value || '').trim();
      if (!v) { alert('Укажите путь к .ifc'); return; }
      location.href = 'viewer.html?ifc=' + encodeURIComponent(v);
    });
  </script>
</body>
</html>
